generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

enum PaymentType {
  TOPUP
  WITHDRAW
}

enum TransferStatus {
  PENDING
  COMPLETED
  FAILED
}

enum ChatSender {
  BORROWER
  LENDER
}

enum LoanStatus {
  PENDING
  ACCEPTED
  REJECTED
  PAID
  WAITING_FOR_RETURN
  COMPLETED
}

enum MeetingStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

model Lender {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  password     String
  address      String?
  phone_number String?
  image_url    String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  products    Product[]
  wallet      Wallet?
  payments    Payment[]
  transfers   Transfer[]
  bankAccount BankAccount?
  chatRooms   ChatRoom[]
  loans       Loan[]

  @@map("lenders")
}

model Borrower {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  password     String
  address      String?
  phone_number String?
  image_url    String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  wallet    Wallet?
  payments  Payment[]
  transfers Transfer[]
  chatRooms ChatRoom[]
  loans     Loan[]

  @@map("borrowers")
}

model Admin {
  id         String   @id @default(uuid())
  email      String   @unique
  password   String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("admins")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Float
  stock       Int
  image_url   String?
  lender_id   String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  lender    Lender     @relation(fields: [lender_id], references: [id])
  loans     Loan[]
  chatRooms ChatRoom[]

  @@map("products")
}

model Wallet {
  id          String   @id @default(uuid())
  borrower_id String?  @unique
  lender_id   String?  @unique
  balance     Decimal  @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  borrower Borrower? @relation(fields: [borrower_id], references: [id])
  lender   Lender?   @relation(fields: [lender_id], references: [id])

  @@map("wallets")
}

model Payment {
  id               String      @id @default(uuid())
  type             PaymentType
  borrower_id      String?
  lender_id        String?
  amount           Decimal
  status           String
  order_id         String      @unique
  transaction_id   String?
  snap_token       String?
  redirect_url     String?
  raw_notification Json?
  created_at       DateTime    @default(now())
  updated_at       DateTime    @updatedAt

  borrower Borrower? @relation(fields: [borrower_id], references: [id])
  lender   Lender?   @relation(fields: [lender_id], references: [id])

  @@map("payments")
}

model Transfer {
  id               String         @id @default(uuid())
  from_borrower_id String
  to_lender_id     String
  amount           Decimal
  status           TransferStatus @default(PENDING)
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  fromBorrower Borrower @relation(fields: [from_borrower_id], references: [id], onDelete: Restrict)
  toLender     Lender   @relation(fields: [to_lender_id], references: [id], onDelete: Restrict)

  @@map("transfers")
}

model BankAccount {
  id             String   @id @default(uuid())
  lender_id      String   @unique
  bank_code      String
  account_number String
  account_name   String
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  lender Lender @relation(fields: [lender_id], references: [id], onDelete: Cascade)

  @@map("bank_accounts")
}

model ChatRoom {
  id          String        @id @default(uuid())
  borrower_id String
  lender_id   String
  product_id  String
  created_at  DateTime      @default(now())
  messages    ChatMessage[]

  borrower Borrower @relation(fields: [borrower_id], references: [id], onDelete: Cascade)
  lender   Lender   @relation(fields: [lender_id], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("chat_rooms")
}

model ChatMessage {
  id         String     @id @default(uuid())
  room_id    String
  sender     ChatSender
  content    String?
  image_url  String?
  created_at DateTime   @default(now())

  room ChatRoom @relation(fields: [room_id], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model Loan {
  id          String     @id @default(uuid())
  product_id  String
  borrower_id String
  lender_id   String
  amount      Decimal
  status      LoanStatus @default(PENDING)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  product  Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  borrower Borrower @relation(fields: [borrower_id], references: [id], onDelete: Cascade)
  lender   Lender   @relation(fields: [lender_id], references: [id], onDelete: Cascade)
  meeting  Meeting?

  @@map("loans")
}

model Meeting {
  id         String        @id @default(uuid())
  loan_id    String        @unique
  lat        Decimal
  lon        Decimal
  address    String
  status     MeetingStatus @default(PENDING)
  qr_token   String?
  qr_expires DateTime?
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt

  loan Loan @relation(fields: [loan_id], references: [id], onDelete: Cascade)

  @@map("meetings")
}
